<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Pastez Bin</title>
  <link rel="icon" href="/static/favicon.ico">
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      background: #1f1d2e;
      font-family: monospace;
      display: flex;
      flex-direction: column;
    }

    /* Tabs */
    #tabs {
      display: flex;
      justify-content: center;
      border-bottom: 1px solid #313244;
      font-size: 13px;
    }

    .tab {
      padding: 6px 14px;
      cursor: pointer;
      color: #6c7086;
    }

    .tab.active {
      color: #cdd6f4;
      border-bottom: 2px solid #89b4fa;
    }

    #content {
      flex: 1;
      display: flex;
    }

    /* Text */
    textarea {
      flex: 1;
      width: 100%;
      padding: 20px;
      border: none;
      outline: none;
      resize: none;
      box-sizing: border-box;
      font-size: 14px;
      background: transparent;
      color: #cdd6f4;
      overflow: auto;
    }

    /* Images */
    #imageView {
      flex: 1;
      padding: 20px;
      overflow: auto;
      display: none;
    }

    .imageWrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 14px;
    }

    .imageWrapper img {
      max-width: 100%;
      display: block;
    }

    /* Per-image controls */
    .imageControls {
      position: absolute;
      top: 6px;
      right: 6px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .imageWrapper:hover .imageControls {
      opacity: 1;
    }

    .imageControls .imgIcon {
      width: 20px;
      /* icon size */
      height: 20px;

      padding: 6px;
      /* background space */
      background: rgba(0, 0, 0, 0.65);
      border-radius: 8px;

      cursor: pointer;
      transition: background 0.2s ease;
    }

    .imageControls .imgIcon:hover {
      background: rgba(0, 0, 0, 0.9);
    }
  </style>
</head>

<body>

  <div id="tabs">
    <div class="tab active" data-mode="text">text</div>
    <div class="tab" data-mode="image">image</div>
  </div>

  <div id="content">
    <textarea id="editor" placeholder="Start typing..."></textarea>
    <div id="imageView"></div>
  </div>

  <script src="static/pako.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {

      const editor = document.getElementById("editor");
      const imageView = document.getElementById("imageView");
      const tabs = document.querySelectorAll(".tab");

      let mode = "text";
      let images = [];

      // -------- Tab Switch --------
      function switchMode(newMode) {
        mode = newMode;

        tabs.forEach(t => t.classList.remove("active"));
        document.querySelector(`[data-mode="${newMode}"]`).classList.add("active");

        editor.style.display = newMode === "text" ? "block" : "none";
        imageView.style.display = newMode === "image" ? "block" : "none";

        saveToURL();
      }

      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          switchMode(tab.dataset.mode);
        });
      });

      // -------- Base64URL helpers --------
      function uint8ToBase64Url(uint8) {
        let binary = '';
        for (let i = 0; i < uint8.length; i++) {
          binary += String.fromCharCode(uint8[i]);
        }
        let base64 = btoa(binary);
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      }

      function base64UrlToUint8(base64url) {
        let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
        while (base64.length % 4) base64 += '=';
        let binary = atob(base64);
        let bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes;
      }

      // -------- Render Images --------
      function renderImages() {
        imageView.innerHTML = "";

        images.forEach((src, index) => {

          const wrapper = document.createElement("div");
          wrapper.className = "imageWrapper";

          const img = document.createElement("img");
          img.src = src;

          const controls = document.createElement("div");
          controls.className = "imageControls";

          // Download icon
          const downloadIcon = document.createElement("img");
          downloadIcon.src = "/static/download.svg";
          downloadIcon.className = "imgIcon";
          downloadIcon.alt = "download";
          downloadIcon.addEventListener("click", async () => {

            const img = new Image();
            img.src = src;

            await img.decode();

            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);

            const link = document.createElement("a");
            link.download = "image.png";
            link.href = canvas.toDataURL("image/png"); // convert to PNG here
            link.click();
          });

          // Delete icon
          const deleteIcon = document.createElement("img");
          deleteIcon.src = "/static/trash.svg";
          deleteIcon.className = "imgIcon";
          deleteIcon.alt = "delete";
          deleteIcon.addEventListener("click", () => {
            images.splice(index, 1);
            renderImages();
            saveToURL();
          });

          controls.appendChild(downloadIcon);
          controls.appendChild(deleteIcon);

          wrapper.appendChild(img);
          wrapper.appendChild(controls);
          imageView.appendChild(wrapper);
        });
      }

      // -------- Save --------
      function saveToURL() {
        const encoder = new TextEncoder();

        if (mode === "text") {
          const input = encoder.encode(editor.value);
          const compressed = pako.deflateRaw(input);
          const encoded = uint8ToBase64Url(compressed);
          history.replaceState(null, null, '#t:' + encoded);
        }

        if (mode === "image") {
          const payload = JSON.stringify(images);
          const input = encoder.encode(payload);
          const compressed = pako.deflateRaw(input);
          const encoded = uint8ToBase64Url(compressed);
          history.replaceState(null, null, '#i:' + encoded);
        }
      }

      // -------- Load --------
      function loadFromURL() {

        if (location.hash.length <= 1) return;

        try {
          const raw = location.hash.substring(1);
          const type = raw.substring(0, 2);
          const encoded = raw.substring(2);

          const compressed = base64UrlToUint8(encoded);
          const decompressed = pako.inflateRaw(compressed);

          const decoder = new TextDecoder();
          const decoded = decoder.decode(decompressed);

          if (type === "t:") {
            editor.value = decoded;
            images = [];
            renderImages();
            switchMode("text");
          }

          if (type === "i:") {
            images = JSON.parse(decoded);
            editor.value = "";
            renderImages();
            switchMode("image");
          }

        } catch (e) {
          console.error("Load failed:", e);
        }
      }

      // -------- Image Paste --------
      document.addEventListener("paste", async (e) => {
        if (mode !== "image") return;

        const items = e.clipboardData.items;

        for (let item of items) {
          if (item.type.startsWith("image/")) {
            e.preventDefault();

            const file = item.getAsFile();
            const bitmap = await createImageBitmap(file);

            const maxWidth = 1200;
            const scale = Math.min(1, maxWidth / bitmap.width);

            const canvas = document.createElement("canvas");
            canvas.width = bitmap.width * scale;
            canvas.height = bitmap.height * scale;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);

            canvas.toBlob((blob) => {
              const reader = new FileReader();
              reader.onload = function () {
                images.push(reader.result); // stored as WebP
                renderImages();
                saveToURL();
              };
              reader.readAsDataURL(blob);
            }, "image/webp", 0.75);

            return;
          }
        }
      });

      // -------- Auto Save --------
      let timeout;
      editor.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(saveToURL, 500);
      });

      loadFromURL();

    });
  </script>

</body>

</html>