<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pastez Bin</title>
<style>
body { margin: 0; font-family: monospace; }
textarea {
  width: 100vw;
  height: 100vh;
  padding: 20px;
  border: none;
  outline: none;
  resize: none;
  box-sizing: border-box;
  font-size: 14px;
  background: transparent;
  color: #cdd6f4;
}
 body { background: #1f1d2e; }
</style>
</head>
<body>

<textarea id="editor" placeholder="Start typing..."></textarea>

<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

<script>
const editor = document.getElementById("editor");

// -------- Base64URL helpers --------
function uint8ToBase64Url(uint8) {
  let binary = '';
  for (let i = 0; i < uint8.length; i++) {
    binary += String.fromCharCode(uint8[i]);
  }
  let base64 = btoa(binary);
  return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

function base64UrlToUint8(base64url) {
  let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
  while (base64.length % 4) base64 += '=';
  let binary = atob(base64);
  let bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) {
    bytes[i] = binary.charCodeAt(i);
  }
  return bytes;
}

// -------- Save --------
function saveToURL() {
  const text = editor.value;
  const encoder = new TextEncoder();
  const input = encoder.encode(text);

  const compressed = pako.deflateRaw(input);
  const encoded = uint8ToBase64Url(compressed);

  history.replaceState(null, null, '#' + encoded);

  console.log("Raw:", input.length, "Compressed:", compressed.length);
}

// -------- Load --------
function loadFromURL() {
  if (location.hash.length <= 1) return;

  try {
    const encoded = location.hash.substring(1);
    const compressed = base64UrlToUint8(encoded);
    const decompressed = pako.inflateRaw(compressed);

    const decoder = new TextDecoder();
    editor.value = decoder.decode(decompressed);

  } catch (e) {
    console.error("Decompression failed:", e);
  }
}

// Debounce
let timeout;
editor.addEventListener('input', () => {
  clearTimeout(timeout);
  timeout = setTimeout(saveToURL, 500);
});

loadFromURL();
</script>

</body>
</html>