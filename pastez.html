<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Pastez Bin</title>
  <link rel="icon" href="/static/favicon.ico">

  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      background: #1f1d2e;
      font-family: monospace;
      display: flex;
      flex-direction: column;
    }

    /* Tabs */
    #tabs {
      display: flex;
      justify-content: center;
      border-bottom: 1px solid #313244;
      font-size: 13px;
    }

    .tab {
      padding: 6px 14px;
      cursor: pointer;
      color: #6c7086;
    }

    .tab.active {
      color: #cdd6f4;
      border-bottom: 2px solid #89b4fa;
    }

    #content {
      flex: 1;
      display: flex;
    }

    textarea {
      flex: 1;
      width: 100%;
      padding: 20px;
      border: none;
      outline: none;
      resize: none;
      box-sizing: border-box;
      font-size: 14px;
      background: transparent;
      color: #cdd6f4;
      overflow: auto;
    }

    .hidden {
      display: none;
    }

    /* Images */
    #imageView {
      flex: 1;
      padding: 20px;
      overflow: auto;
    }

    /* CSS Placeholder (no JS needed) */
    #imageView:empty::before {
      content: "Paste an image here (Ctrl+V)";
      display: flex;
      height: 100%;
      align-items: center;
      justify-content: center;
      color: #6c7086;
      opacity: 0.6;
      font-size: 14px;
    }

    .imageWrapper {
      position: relative;
      display: inline-block;
      margin-bottom: 14px;
    }

    .imageWrapper img {
      max-width: 100%;
      display: block;
    }

    .imageControls {
      position: absolute;
      top: 6px;
      right: 6px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .imageWrapper:hover .imageControls {
      opacity: 1;
    }

    .imgIcon {
      width: 20px;
      height: 20px;
      padding: 6px;
      background: rgba(0, 0, 0, 0.65);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .imgIcon:hover {
      background: rgba(0, 0, 0, 0.9);
    }
  </style>
</head>

<body>

  <div id="tabs">
    <div class="tab active" data-mode="text">text</div>
    <div class="tab" data-mode="image">image</div>
  </div>

  <div id="content">
    <textarea id="editor" placeholder="Start typing..."></textarea>
    <div id="imageView" class="hidden"></div>
  </div>

  <script src="static/pako.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {

      const editor = document.getElementById("editor");
      const imageView = document.getElementById("imageView");
      const tabs = document.querySelectorAll(".tab");

      let mode = "text";
      let images = [];
      let lastHash = "";

      /* -------- Tab Switch -------- */
      function switchMode(newMode) {
        mode = newMode;

        tabs.forEach(t =>
          t.classList.toggle("active", t.dataset.mode === newMode)
        );

        editor.classList.toggle("hidden", newMode !== "text");
        imageView.classList.toggle("hidden", newMode !== "image");
        saveToURL();
      }

      tabs.forEach(tab => {
        tab.addEventListener("click", () => {
          switchMode(tab.dataset.mode);
        });
      });

      /* -------- Base64URL helpers -------- */
      function uint8ToBase64Url(uint8) {
        let binary = '';
        for (let i = 0; i < uint8.length; i++) {
          binary += String.fromCharCode(uint8[i]);
        }
        return btoa(binary)
          .replace(/\+/g, '-')
          .replace(/\//g, '_')
          .replace(/=+$/, '');
      }

      function base64UrlToUint8(base64url) {
        let base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
        while (base64.length % 4) base64 += '=';
        let binary = atob(base64);
        let bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes;
      }

      function renderImages(src, index) {

        const wrapper = document.createElement("div");
        wrapper.className = "imageWrapper";

        const img = document.createElement("img");
        img.src = src;

        const controls = document.createElement("div");
        controls.className = "imageControls";

        const downloadIcon = document.createElement("img");
        downloadIcon.src = "/static/download.svg";
        downloadIcon.className = "imgIcon";
        downloadIcon.alt = "download";

        downloadIcon.addEventListener("click", async () => {
          const image = new Image();
          image.src = src;
          await image.decode();

          const canvas = document.createElement("canvas");
          canvas.width = image.width;
          canvas.height = image.height;
          canvas.getContext("2d").drawImage(image, 0, 0);

          const link = document.createElement("a");
          link.download = "image.png";
          link.href = canvas.toDataURL("image/png");
          link.click();
        });

        const deleteIcon = document.createElement("img");
        deleteIcon.src = "/static/trash.svg";
        deleteIcon.className = "imgIcon";
        deleteIcon.alt = "delete";

        deleteIcon.addEventListener("click", () => {
          images.splice(index, 1);
          wrapper.remove();
          saveToURL();
        });

        controls.appendChild(downloadIcon);
        controls.appendChild(deleteIcon);

        wrapper.appendChild(img);
        wrapper.appendChild(controls);
        imageView.appendChild(wrapper);
      }

      /* -------- Save -------- */
      function saveToURL() {
        const encoder = new TextEncoder();
        let newHash = "";

        if (mode === "text") {
          const compressed = pako.deflateRaw(encoder.encode(editor.value));
          newHash = '#t:' + uint8ToBase64Url(compressed);
        }

        if (mode === "image") {
          const payload = JSON.stringify(images);
          const compressed = pako.deflateRaw(encoder.encode(payload));
          newHash = '#i:' + uint8ToBase64Url(compressed);
        }

        if (newHash !== lastHash) {
          history.replaceState(null, null, newHash);
          lastHash = newHash;
        }
      }

      /* -------- Load -------- */
      function loadFromURL() {
        if (location.hash.length <= 1) return;

        try {
          const raw = location.hash.substring(1);
          const type = raw.substring(0, 2);
          const encoded = raw.substring(2);

          const decompressed = pako.inflateRaw(
            base64UrlToUint8(encoded)
          );

          const decoded = new TextDecoder().decode(decompressed);

          if (type === "t:") {
            editor.value = decoded;
            switchMode("text");
          }

          if (type === "i:") {
            images = JSON.parse(decoded);
            switchMode("image");
            images.forEach((src, i) => renderImages(src, i));
          }

        } catch (e) {
          console.error("Load failed:", e);
        }
      }

      /* -------- Image Paste -------- */
      document.addEventListener("paste", async (e) => {
        if (mode !== "image") return;

        for (let item of e.clipboardData.items) {
          if (item.type.startsWith("image/")) {
            e.preventDefault();

            const file = item.getAsFile();
            const bitmap = await createImageBitmap(file);

            const maxWidth = 1200;
            const scale = Math.min(1, maxWidth / bitmap.width);

            const canvas = document.createElement("canvas");
            canvas.width = bitmap.width * scale;
            canvas.height = bitmap.height * scale;

            canvas.getContext("2d")
              .drawImage(bitmap, 0, 0, canvas.width, canvas.height);

            bitmap.close();

            canvas.toBlob(blob => {
              const reader = new FileReader();
              reader.onload = function () {
                images.push(reader.result);
                renderImages(reader.result, images.length - 1);
                saveToURL();
              };
              reader.readAsDataURL(blob);
            }, "image/webp", 0.75);

            return;
          }
        }
      });

      /* -------- Auto Save -------- */
      let timeout;
      editor.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(saveToURL, 500);
      });

      loadFromURL();

    });
  </script>

</body>

</html>